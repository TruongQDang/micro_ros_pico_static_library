# Micro-ROS Static Library for Raspberry Pi Pico
This guide demonstrates how to build a micro-ROS static library for the Raspberry Pi Pico, including integration of a custom ROS 2 message type.

## Install the micro-ROS build system
```
# Source the ROS 2 installation
source /opt/ros/$ROS_DISTRO/setup.bash

# Create a workspace and download the micro-ROS tools
mkdir microros_ws
cd microros_ws
git clone -b $ROS_DISTRO https://github.com/micro-ROS/micro_ros_setup.git src/micro_ros_setup

# Update dependencies using rosdep
sudo apt update && rosdep update
rosdep install --from-paths src --ignore-src -y

# Build micro-ROS tools and source them
colcon build
source install/local_setup.bash
```

## Prepare the micro-ROS environment
```
ros2 run micro_ros_setup create_firmware_ws.sh generate_lib
```

## Prepare the custom ROS message
```
cd firmware/mcu_ws
ros2 pkg create --build-type ament_cmake my_custom_message
cd my_custom_message
mkdir msg
touch msg/MyCustomMessage.msg
```

In the autogenerated `CMakeLists.txt` file you should add the following lines just before `ament_package()`:
```
...
find_package(rosidl_default_generators REQUIRED)

rosidl_generate_interfaces(${PROJECT_NAME}
  "msg/MyCustomMessage.msg"
 )
...
```

In the autogenerated `package.xml` file you should add the following lines:
```
...
<build_depend>rosidl_default_generators</build_depend>
<exec_depend>rosidl_default_runtime</exec_depend>
<member_of_group>rosidl_interface_packages</member_of_group>
...
```

## Building the custom library
**Preaparing configuration files for cross-compilation:**
```
git clone https://github.com/TruongQDang/micro_ros_pico_static_library.git
```

**Building:**
```
ros2 run micro_ros_setup build_firmware.sh $(pwd)/toolchain.cmake $(pwd)/colcon.meta
```
Once the build finishes you will have a precompiled static library with all the micro-ROS functionality in `firmware/build/libmicroros.a` and you will have all the required headers for your application in `firmware/build/include`.

**Cleanup:**

To copy the static library and headers into your firmware development workspace (and then do a cleanup of the headers), update the `FIRMWARE_DEV_PATH` variable in `library_generation.sh` with its absolute path, then run:
```
bash library_generation.sh 
```

## Link custom message package
To create a symbolic link to the custom message package in other ROS 2 workspaces, set the `SOURCE_DIR` and `TARGET_DIR` variables in `symlink_dir.sh`, then run:
```
bash symlink_dir.sh
```